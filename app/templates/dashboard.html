{# templates/dashboard.html â€” versÃ£o 100 % alinhada Ã  nova view  #}
{% extends "base.html" %}
{% block title %}Your Cosmic Dashboard â€¢ SkyAI{% endblock %}

{% block content %}
<div class="box-container" style="max-width:860px;">

  <!-- â–¸ CabeÃ§alho -------------------------------------------------------- -->
  <div class="dashboard-header"
       style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:2.5rem;">
    <h2 style="margin:0;">Welcome, {{ nome.split()[0] if nome else 'User' }} ğŸŒŸ</h2>
    <a href="{{ url_for('auth_views.logout') }}"
       style="font-size:.9rem;color:#fff;text-decoration:none;font-weight:500;border:1px solid var(--primary-color);
              padding:.4rem .8rem;border-radius:8px;">Logout</a>
  </div>

  <!-- â–¸ Dados do usuÃ¡rio -------------------------------------------------- -->
  <div style="background:rgba(255,255,255,.05);padding:1rem 1.5rem;border-radius:12px;margin-bottom:2rem;color:#ddd;">
    <p><strong>Full Name:</strong> {{ nome }}</p>
    <p><strong>Email:</strong> {{ email }}</p>
  </div>

  {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     1) Se AINDA NÃƒO houve pagamento  â†’  banner de pagamento
     show_pay_banner == True  (variÃ¡vel vinda da view)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% if show_pay_banner %}
    <div class="section-card"
         style="background:rgba(255,0,0,0.1);padding:1.5rem;border-radius:12px;margin-top:1rem;color:#fdd;">
      <p>âš ï¸ You need to pay to unlock your Astral Map, Compatibility and Guru questions.</p>
      <a href="https://buy.stripe.com/bJefZg96w76eaLn0zj5AQ09" class="btn-primary">ğŸ’³ Pay Now</a>
    </div>
  {% else %}
  {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     2) ConteÃºdo liberado APÃ“S pagamento
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}

    {# â–¸ RelatÃ³rio Astral --------------------------------------------------- #}
    {% set has_report = total > 0 %}
    {% if not has_report %}
      <div class="actions" style="margin:2rem 0;">
        <a href="{{ url_for('user.preencher_dados') }}"
           class="btn-primary" style="width:100%;">ğŸª Generate Your Astral Map</a>
      </div>
    {% else %}
      <div class="actions" style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:2rem;">
        <a href="{{ url_for('user.gerar_relatorio', sessao_id=ultima_sessao.id) }}"
           class="btn-primary" style="text-align:center;flex:1 1 auto;">ğŸ” View My Report</a>
      </div>
    {% endif %}

    {# â–¸ Compatibilidade Amorosa ------------------------------------------- #}
    {% set has_compat = user.compatibility_used if user is defined else false %}
    <div class="section-card highlight"
         style="background:rgba(255,255,255,0.04);padding:1.5rem;border-radius:12px;margin-top:1rem;">
      <h3 style="color:#ffddcc;margin-bottom:.8rem;">ğŸ’˜ Love Compatibility</h3>
      <p style="color:#ccc;margin-bottom:1rem;">
        Discover the cosmic chemistry between you and a partner.
      </p>

      {% if not has_compat %}
        <a href="{{ url_for('user.compatibility_form') }}"
           class="btn-primary" style="width:100%;">ğŸ’ Start Compatibility Test</a>
      {% else %}
        <p style="color:#fcd5ce;">âœ… You have already used your Love Compatibility test.</p>
      {% endif %}
    </div>

    {# â–¸ Guru SkyAI --------------------------------------------------------- #}
    <div class="section-card"
         style="background:rgba(255,255,255,0.04);padding:1.5rem;border-radius:12px;margin-top:2rem;">
      <h3 style="color:#ffdd77;margin-bottom:1rem;">ğŸ§™â€â™‚ï¸ Ask the Guru SkyAI</h3>

      {% if not limit_exceeded %}
        <form action="{{ url_for('user.ask_guru') }}" method="post">
          <textarea name="question" placeholder="Type your question here..." required
                    style="width:100%;height:120px;border-radius:10px;padding:1rem;font-size:1rem;"></textarea>
          <button type="submit" class="btn-primary" style="width:100%;margin-top:1rem;">ğŸ”® Ask the Guru</button>
        </form>
        <p style="color:#eee;margin-top:1rem;">âœ¨ You have {{ remaining_questions }} question{{ 's' if remaining_questions != 1 else '' }} remaining.</p>
      {% else %}
        <p style="color:#fcd5ce;">âš ï¸ You have used all your Guru questions.</p>
      {% endif %}
    </div>

    {# â–¸ Se tudo utilizado, mostra â€œBuy Againâ€ ----------------------------- #}
    {% if has_report and has_compat and limit_exceeded %}
      <div class="section-card"
           style="background:rgba(255,255,255,0.04);padding:1.5rem;border-radius:12px;margin-top:2rem;text-align:center;">
        <h3 style="color:#ffcc00;margin-bottom:1rem;">ğŸ”„ Unlock More!</h3>
        <p style="color:#ccc;margin-bottom:1rem;">
          You've used all features. Purchase again to unlock a new report,
          compatibility, and more Guru questions!
        </p>
        <a href="https://buy.stripe.com/bJefZg96w76eaLn0zj5AQ09" class="btn-primary">ğŸ’³ Buy Again</a>
      </div>
    {% endif %}

    {# â–¸ Respostas recentes do Guru --------------------------------------- #}
    {% if guru_answers %}
      <div class="section-card"
           style="background:rgba(255,255,255,0.04);padding:1.5rem;border-radius:12px;margin-top:2rem;">
        <h3 style="color:#FCE495;margin-bottom:1rem;">ğŸ§™â€â™€ï¸ Recent Answers from Guru SkyAI</h3>
        {% for q in guru_answers %}
          <div style="margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1);">
            <p style="color:#ddd;"><strong>ğŸ“ Question:</strong> {{ q.question }}</p>
            {% if q.answer %}
              <p style="color:#eee;margin-top:.5rem;"><strong>ğŸ”® Answer:</strong> {{ q.answer }}</p>
            {% else %}
              <p style="color:#aaa;margin-top:.5rem;">â³ Answer pendingâ€¦</p>
            {% endif %}
            <p style="font-size:.85rem;color:#999;margin-top:.75rem;">
              <em>{{ q.created_at.strftime('%b %d, %Y %H:%M') }}</em>
            </p>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  {% endif %} {# / show_pay_banner #}

</div>
{% endblock %}
